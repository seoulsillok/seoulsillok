---
import { dongRecords } from '../data/dongs';

const mapRegions = dongRecords
  .filter((dong) => Boolean(dong.mapPath))
  .map((dong) => ({
    id: dong.slug,
    label: `${dong.nameKo} · ${dong.nameEn}`,
    nameKo: dong.nameKo,
    nameEn: dong.nameEn,
    district: dong.district,
    instagram: dong.instagramUrl,
    path: dong.mapPath
  }))
  .sort((a, b) => a.nameKo.localeCompare(b.nameKo, 'ko'));

const featuredRegions = mapRegions.slice(0, 8);
---

<section class="map-viewport" aria-labelledby="map-title">
  <div class="map-gradient" aria-hidden="true"></div>

  <svg
    viewBox="0 0 800 800"
    class="seoul-map"
    role="img"
    aria-labelledby="map-graphic-title map-graphic-description"
    preserveAspectRatio="xMidYMid meet"
  >
    <defs>
      <radialGradient id="map-gradient" cx="50%" cy="40%" r="80%">
        <stop offset="0%" stop-color="#dfeafe" stop-opacity="0.95" />
        <stop offset="70%" stop-color="#b4c8ff" stop-opacity="0.75" />
        <stop offset="100%" stop-color="#8aa9ff" stop-opacity="0.35" />
      </radialGradient>
      <filter id="map-shadow" x="-20%" y="-20%" width="140%" height="140%">
        <feDropShadow dx="0" dy="24" stdDeviation="24" flood-color="rgba(11,31,59,0.22)" flood-opacity="0.22" />
      </filter>
    </defs>

    <title id="map-graphic-title">서울 인터랙티브 지도</title>
    <desc id="map-graphic-description">동네를 가볍게 가리키면 강조되고, 클릭하면 연결된 인스타그램 기록을 새 창으로 엽니다.</desc>

    <rect x="80" y="40" width="640" height="640" fill="url(#map-gradient)" rx="120" ry="120" opacity="0.55" />

    {mapRegions.map((region) => (
      <path
        class="dong-shape"
        id={`dong-${region.id}`}
        role="link"
        tabindex="0"
        d={region.path}
        aria-label={`${region.label} — Instagram으로 이동`}
        data-name={region.label}
        data-instagram={region.instagram || ''}
      >
        <title>{region.label}</title>
      </path>
    ))}
  </svg>

  <div id="map-tooltip" class="map-tooltip" role="presentation"></div>

  <article class="map-overlay">
    <header class="overlay-header">
      <p class="eyebrow">서울 실록 · Seoul Sillok</p>
      <h1 id="map-title">서울을 동네별로 탐험하세요</h1>
      <p id="map-description" class="overlay-copy">
        마우스나 키보드로 지도를 가리키면 해당 동네가 빛나고, 선택하면 연결된 인스타그램 기록이 새 창으로 열립니다.
      </p>
    </header>
    <div class="overlay-actions">
      <a class="overlay-link" href="/about">About</a>
      <a class="overlay-link overlay-link--ghost" href="/projects">Projects</a>
    </div>
    <ul class="overlay-dongs" aria-label="대표 동네 바로가기">
      {featuredRegions.map((region) => (
        <li class="overlay-dong" key={region.id}>
          <a href={`/dong/${region.id}`}>
            <span class="dong-name">{region.nameKo}</span>
            <span class="dong-meta">{region.nameEn} · {region.district}</span>
          </a>
        </li>
      ))}
    </ul>
  </article>
</section>

<script client:load>
  const tooltip = document.getElementById('map-tooltip');
  const shapes = Array.from(document.querySelectorAll('.dong-shape'));
  const container = document.querySelector('.map-viewport');

  const setTooltipPosition = (x, y) => {
    if (!tooltip || !container) return;
    const rect = container.getBoundingClientRect();
    tooltip.style.left = `${x - rect.left + 16}px`;
    tooltip.style.top = `${y - rect.top + 16}px`;
  };

  const showTooltip = (event, shape, name) => {
    if (!tooltip || !container) return;
    tooltip.textContent = name;
    tooltip.classList.add('is-visible');

    if (event instanceof MouseEvent) {
      setTooltipPosition(event.clientX, event.clientY);
    } else {
      const rect = shape.getBoundingClientRect();
      setTooltipPosition(rect.left + rect.width / 2, rect.top + rect.height / 2);
    }
  };

  const hideTooltip = () => {
    if (!tooltip) return;
    tooltip.classList.remove('is-visible');
  };

  const moveTooltip = (event) => {
    if (!tooltip || !tooltip.classList.contains('is-visible')) return;
    setTooltipPosition(event.clientX, event.clientY);
  };

  const openInstagram = (instagram) => {
    if (!instagram) return;
    window.open(instagram, '_blank', 'noopener,noreferrer');
  };

  shapes.forEach((shape) => {
    const name = shape.dataset.name || '';
    const instagram = shape.dataset.instagram || '';

    shape.addEventListener('mouseenter', (event) => showTooltip(event, shape, name));
    shape.addEventListener('mousemove', moveTooltip);
    shape.addEventListener('mouseleave', hideTooltip);
    shape.addEventListener('focus', (event) => showTooltip(event, shape, name));
    shape.addEventListener('blur', hideTooltip);

    shape.addEventListener('click', () => openInstagram(instagram));
    shape.addEventListener('keydown', (event) => {
      if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        openInstagram(instagram);
      }
    });
  });
</script>

<style>
  .map-viewport {
    position: relative;
    min-height: 100vh;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: calc(var(--nav-height, 72px) + 1.5rem) clamp(1.5rem, 6vw, 4rem) 4rem;
    background: radial-gradient(circle at top, #edf2ff 0%, #d9e2ff 58%, #c2d4ff 100%);
  }

  .map-gradient {
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at 50% 25%, rgba(255, 255, 255, 0.6) 0%, rgba(255, 255, 255, 0) 60%);
    opacity: 0.8;
    pointer-events: none;
    z-index: 0;
  }

  .seoul-map {
    position: relative;
    width: min(920px, 88vw);
    height: auto;
    aspect-ratio: 1;
    display: block;
    filter: drop-shadow(0 28px 70px rgba(11, 31, 59, 0.18));
    z-index: 1;
  }

  .dong-shape {
    fill: rgba(11, 102, 255, 0.32);
    stroke: rgba(11, 31, 59, 0.48);
    stroke-width: 3;
    transition: fill 0.35s ease, transform 0.35s ease, stroke 0.35s ease;
    cursor: pointer;
    filter: url(#map-shadow);
  }

  .dong-shape:hover,
  .dong-shape:focus {
    fill: rgba(11, 102, 255, 0.7);
    stroke: rgba(11, 31, 59, 0.95);
    transform: translateY(-6px) scale(1.01);
    outline: none;
  }

  .dong-shape:focus-visible {
    stroke-width: 4;
  }

  .map-tooltip {
    position: absolute;
    pointer-events: none;
    background: rgba(11, 31, 59, 0.85);
    color: #fff;
    padding: 0.55rem 0.85rem;
    border-radius: 999px;
    font-size: 0.85rem;
    letter-spacing: 0.02em;
    opacity: 0;
    transform: translate3d(-50%, -120%, 0);
    transition: opacity 0.2s ease;
    white-space: nowrap;
    z-index: 3;
  }

  .map-tooltip.is-visible {
    opacity: 1;
  }

  .map-overlay {
    position: absolute;
    top: calc(var(--nav-height, 72px) + 1.5rem);
    left: clamp(1.5rem, 6vw, 4rem);
    width: min(340px, 32vw);
    display: grid;
    gap: 1.5rem;
    padding: 1.8rem;
    background: rgba(255, 255, 255, 0.82);
    border: 1px solid rgba(11, 31, 59, 0.08);
    border-radius: 28px;
    backdrop-filter: blur(16px);
    box-shadow: 0 25px 60px rgba(11, 31, 59, 0.18);
    z-index: 2;
    color: rgba(11, 31, 59, 0.88);
  }

  .overlay-header {
    display: grid;
    gap: 0.85rem;
  }

  .eyebrow {
    margin: 0;
    font-size: 0.8rem;
    letter-spacing: 0.24em;
    text-transform: uppercase;
    color: rgba(11, 31, 59, 0.55);
  }

  h1 {
    margin: 0;
    font-size: clamp(2.1rem, 4vw, 2.6rem);
    color: rgba(11, 31, 59, 0.92);
  }

  .overlay-copy {
    margin: 0;
    font-size: 1rem;
    line-height: 1.7;
    color: rgba(11, 31, 59, 0.7);
  }

  .overlay-actions {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .overlay-link {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.8rem 1.4rem;
    border-radius: 999px;
    background: rgba(11, 102, 255, 0.9);
    color: #fff;
    text-decoration: none;
    font-size: 0.95rem;
    transition: transform 0.25s ease, box-shadow 0.25s ease;
  }

  .overlay-link:hover,
  .overlay-link:focus-visible {
    transform: translateY(-2px);
    box-shadow: 0 12px 20px rgba(11, 102, 255, 0.24);
  }

  .overlay-link--ghost {
    background: rgba(255, 255, 255, 0.92);
    color: rgba(11, 31, 59, 0.88);
    border: 1px solid rgba(11, 31, 59, 0.12);
  }

  .overlay-dongs {
    margin: 0;
    padding: 0;
    list-style: none;
    display: grid;
    gap: 0.9rem;
  }

  .overlay-dong a {
    display: grid;
    gap: 0.2rem;
    padding: 0.9rem 1rem;
    border-radius: 18px;
    background: rgba(255, 255, 255, 0.92);
    text-decoration: none;
    color: inherit;
    border: 1px solid rgba(11, 31, 59, 0.08);
    transition: border-color 0.25s ease, transform 0.25s ease, box-shadow 0.25s ease;
  }

  .overlay-dong a:hover,
  .overlay-dong a:focus-visible {
    border-color: rgba(11, 102, 255, 0.35);
    transform: translateX(6px);
    box-shadow: 0 14px 28px rgba(11, 102, 255, 0.18);
  }

  .dong-name {
    font-weight: 600;
    font-size: 1.05rem;
  }

  .dong-meta {
    font-size: 0.85rem;
    color: rgba(11, 31, 59, 0.55);
  }

  @media (max-width: 1080px) {
    .map-overlay {
      width: min(360px, 42vw);
    }
  }

  @media (max-width: 900px) {
    .map-viewport {
      padding: calc(var(--nav-height, 72px) + 1rem) clamp(1.2rem, 5vw, 3rem) 3rem;
    }

    .map-overlay {
      width: min(340px, 48vw);
    }
  }

  @media (max-width: 720px) {
    .map-viewport {
      flex-direction: column;
      align-items: center;
      padding: calc(var(--nav-height, 72px) + 1rem) clamp(1rem, 4vw, 2rem) 3rem;
    }

    .map-overlay {
      position: static;
      width: 100%;
      margin-top: 1.5rem;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 26px;
    }

    .seoul-map {
      width: min(560px, 100%);
    }
  }

  @media (max-width: 520px) {
    .overlay-actions {
      flex-direction: column;
    }

    .overlay-link {
      width: 100%;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .dong-shape,
    .overlay-link,
    .overlay-dong a {
      transition: none;
    }

    .dong-shape:hover,
    .dong-shape:focus {
      transform: none;
    }
  }
</style>
